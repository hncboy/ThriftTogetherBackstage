<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pro516.thrifttogetherbackstage.mapper.CouponMapper">

    <resultMap id="simpleCouponResultMap" type="SimpleCouponVO">
        <result column="id" property="couponId"/>
        <result column="coupon_name" property="couponName"/>
        <result column="coupon_integral" property="couponIntegral"/>
        <result column="coupon_image_url" property="couponImageUrl"/>
    </resultMap>

    <resultMap id="couponDetailsResultMap" type="CouponDetailsVO">
        <result column="id" property="couponId"/>
        <result column="coupon_integral" property="couponIntegral"/>
        <result column="coupon_details_image_url" property="couponDetailsImageUrl"/>
        <result column="discounted_price" property="couponDiscountedPrice"/>
        <result column="expired_date" property="expiredDate"/>
    </resultMap>

    <resultMap id="userCouponResultMap" type="UserCoupon">
        <result column="id" property="userCouponId"/>
        <result column="coupon_image_url" property="couponImageUrl"/>
        <result column="discounted_price" property="couponDiscountedPrice"/>
        <result column="expired_date" property="expiredDate"/>
        <result column="user_coupon_status" property="userCouponStatus"/>
    </resultMap>

    <!-- 获取所有优惠券 -->
    <select id="listSimpleCoupons" resultMap="simpleCouponResultMap">
        SELECT
            id,
            coupon_name,
            coupon_integral,
            coupon_image_url
        FROM
            coupon
        WHERE
            coupon_status = 1
    </select>

    <!-- 根据优惠卷id查询优惠券详情 -->
    <select id="getCouponDetailsByCouponId" parameterType="Integer" resultMap="couponDetailsResultMap">
        SELECT
            id,
            coupon_name,
            coupon_integral,
            coupon_details_image_url,
            discounted_price,
            expired_date
        FROM
            coupon
        WHERE
            coupon_status = 1
            AND id = ${couponId}
    </select>

    <!-- 根据用户id和用户优惠券状态查询领取的优惠券 -->
    <select id="listUserCoupons" parameterType="Integer" resultMap="userCouponResultMap">
        SELECT
            id,
            ( SELECT coupon_image_url FROM coupon WHERE coupon_id = id ) as coupon_image_url,
            ( SELECT discounted_price FROM coupon WHERE coupon_id = id ) as discounted_price,
            ( SELECT expired_date FROM coupon WHERE coupon_id = id ) as expired_date,
            user_coupon_status
        FROM
            user_coupon
        WHERE
            user_coupon_status = ${userCouponStatus}
            AND user_id = ${userId}
        ORDER BY
            receive_time
    </select>

    <!-- 更新优惠券状态 -->
    <update id="updateCouponStatus">
        update coupon set coupon_status = 2 where (day(now()) - day(expired_date)) = 0
    </update>

    <!-- 更新优惠券状态 -->
    <update id="updateUserCouponStatus" parameterType="Integer">
        UPDATE user_coupon
        SET user_coupon_status = 3
        WHERE
            user_id = 1
            AND coupon_id IN (
            SELECT
                id
            FROM
                coupon
            WHERE
            coupon_status = 2
            )
    </update>
</mapper>